---
file-created: 2023 11 25
last-modified: 2023 11 25
---
## 评教系统

[toc]

###  环境准备

* Chrome 和对应版本驱动
* Python3

### 运行结果

```bash
python main.py
```

![[Pasted image 20231123204927.webp]]
### 全局配置说明

```python
# 全局配置信息
Username = "username"
Password = "password"

Configuration = {
    # 过滤无效信息
    "MessageFilter": True,
    # 显示树形结构 用于展示已有的评价信息
    "ShowTree": True,
    # 等待间隔 最好不要低于2秒 具体解释查看文档
    "Interval": 2,
    # 是否使用无头浏览器
    "Headless": True
}
```


### Feature

* 无效消息过滤 

因为评论信息中存在比较多的无效信息,所以提供了消息过滤功能. 以下是会被过滤的消息 

```txt
好。。。。。。。。。。。。
0987654321
11111111111
。。。。。。。。。。。。。
收获颇多。。。。。。
************
```

* 显示项目结构 

帮助用户快速了解以保存的学期和课程评价信息.

```txt
评教信息目录
└── 2022-2023学年2学期
    └── 概率论与数理统计B
```

* 增量更新 默认开启

如果当前已经获取部分学期的课程评论,不会再重新获取,提高程序的运行效率. 






## 持久化逻辑

评教文件都存放在当前项目的`review`文件夹下. 每学期创建一个excel文件,学期内的每门课的评价作为一个sheet存放. 

学期 --> workbook 
课程评价 --> sheet




---





## 开发者文档

### 项目流程

核心流程只有 `GetLoginToken` 和 `GetSemesters` . 前者使用 `seleium`获取登陆后的 `token`,后者携带 `token` 获取评教信息.

```python
if __name__ == '__main__':
    CheckEnvironment()
  
    GetLoginToken()
    GetSemesters()
  
    ExitApplication()

```

### Token的获取

没有验证码,不算有难度的 `seleium`代码. 唯一需要注意的是,该服务有 CAS 登陆注册中心,会进行多次网页跳转,`seleium` 不会对其进行阻塞,需要等待跳转完成后再获取元素.

```python
url = "https://jxzlpj.wit.edu.cn"
```

拼装`Header`时需要注意,需要将`token` 同时添加到 `cookie` 和`Authorization`中 . 

```python
    cookies = driver.get_cookies()
    # 更新header
    cookie = ""
    token = ""
    for data in cookies:
        if data["name"] == "Admin-Token":
            token = data["value"]
        cookie += data["name"] + "=" + data["value"] + ";"

    Header_Template["Cookie"] = cookie + "sidebarStatus=0;"
    Header_Template["Authorization"] = "Bearer " + token
```



### 获取评教信息

流程

1. 获取全部的学期信息
2. 获取学期对应的全部课程信息
3. 获取课程的详细评价

好消息是,这三个请求响应的都是json格式的数据,并且格式类似.

#### 学期信息查询

```python
url = "https://jxzlpj.wit.edu.cn/prod-api/jsda/stuTask/list?pageNum=1&pageSize=45&isAsc=descending&orderByColumn=create_time"
```

其返回结果大致为.

```json
{
    "code" : 200 ,
    "rows" : [
         {
          // 学期id
          "id": "1645735863019864066",
          "startDate": "2023-06-06",
          "endDate": "2023-06-20",
          // 发布状态   
          "statusEnum": "1",
          "status": "已发布",
          // 我用该字段作为excel的文件名
          "xnMark": "2022-2023学年2学期",
      }
    ]
}
```

#### 获取一个学期中全部的课程信息

```python
url = "https://jxzlpj.wit.edu.cn/prod-api/jsda/stuTask/list/" + 学期id + "?taskId=" + 学期id + "&pageNum=1&pageSize=15"
```

```json
{
  "rows": [
      {
          // 课程id
          "id": "1563",
          // 课程名称
          "kcmc": "概率论与数理统计B",
          // 这里获取的已评论次数未必准确,不能用于计算发送获取评论详情的次数
          "times": 149,
          "evalTimes": 141,
        
        
      }
  ],
  "code": 200,
}
```

#### 获取该课程的详细评价

```python
url = "https://jxzlpj.wit.edu.cn/prod-api/jsda/stuTask/result?taskDetailId=" + 课程id + "&pageNum=1&pageSize=15"
```

```json
{
    "code" : 200,
    // 这里的才是评论的真实数量
    "total": 147,
     "rows": [
      {		
          // 正面评价
          "remarkZhms": "好。。。。。。。。。。。。",
          "id": "gad8ypexf2z8q6i928e2b2ko9s97hywnjwnh",
          // 改进意见
          "remarkYjhjy": "无。。。。。。。。。。。。"
      },
       {
          "remarkZhms": "好。。。。。。。。。。。。",
          "id": "gad8ypexf2z8q6i928e2b2ko9s97hywnjwnh",
          "remarkYjhjy": "无。。。。。。。。。。。。"
      },
         ....
    ]
}
```

---



### Feature 实现

#### 消息过滤 

因为评论信息中存在比较多的无效信息,所以提供了消息过滤功能. 

过滤逻辑: 

1. 不与其他评论一致.
2. 评论包含有效信息. 

下面是会被过滤的信息.

```txt
好。。。。。。。。。。。。
0987654321
11111111111
。。。。。。。。。。。。。
收获颇多。。。。。。
************
```

##### 实现原理

1. 数组去重 

```python
def DeDuplication(List: list) -> list:
    """
    利用字典的key不可重复性来去重
    不使用set的原因是其中的元素必须是可哈希的 而我们这里是一个列表
    :param List: 列表
    :return:
    """

    Dict = {}
    for data in List:
        Dict[data] = None
    return list(Dict.keys())
```

2. 计算中文字符的长度

```python
def ValidLength(content: str) -> int:
    """
    计算有效长度 ,原理是通过判断字符的unicode编码来判断是否是中文内容,
    可以过滤数字,英文,符号等内容,但是可能
    会有一些误判,不影响整体的使用
    :param content: 评教内容
    :return:
    """
    length = 0
    for i in content:
        if ord(i) > 12904 and ord(i) < 65535:
            length += 1
    return length

```


#### 显示项目结构

直接预览以保存的学期和课程评价. 

##### 实现原理 

利用[Rich](https://rich.readthedocs.io/en/stable/index.html)库的[Tree](https://rich.readthedocs.io/en/stable/tree.html) 实现.
示例代码

```python
from rich.tree import Tree
from rich import print

tree = Tree("评教目录")
tree.add("学期1").add("课程1")
tree.add("学期2").add("课程1").add("课程2")
print(tree)
```

```txt
评教目录
├── 学期1
│   └── 课程1
└── 学期2
    └── 课程1
        └── 课程2
```

#### 增量更新

如果当前已经获取部分学期的课程评论,不会再重新获取,提高程序的运行效率. 

##### 实现原理 

1. 获取本地excel文件列表

```python
def CheckHistory():
    """
    获取历史记录避免提取重复内容, 如果是第一次获取,就创建一个文件夹用于存储评价内容
    :return:
    """
    global FileList
    # 获取已经存在的文件列表
    if os.path.exists("review"):
        FileList = os.listdir("review")
        FileList = [filename[:-5] for filename in FileList if filename.endswith(".xlsx")]
    else:
        os.mkdir("review")
    rich.print("历史记录检测[bold green]通过[/bold green]")
```

2. 获取sheetnames


当`Semester`对象初始时,会提取已保存的课程评论. 


```python 
class Semester:
    def __init__(self, id, name, status=False):
        # ...
        if name in FileList:
            self.workbook = openpyxl.load_workbook("review/" + name + ".xlsx")
            self.sheets = self.workbook.sheetnames
        else:
            self.workbook = openpyxl.Workbook()
            self.workbook.remove(self.workbook["Sheet"])
            self.sheets = []
```

每次新增课程时,都会检查当前课程是否已经存在. 






## 其他



| 作者 : 董作格   | Github : [KM911](https://github.com/KM911) |
| --------------- | ------------------------------------------ |
| 入学年份 : 2021 | 专业 : 数据科学于大数据技                  |



如果终端不支持256色的话,渲染效果无法保证.

新版本的Chrome的devtools的提示信息关闭不了. 当然也可能是我才疏学浅.